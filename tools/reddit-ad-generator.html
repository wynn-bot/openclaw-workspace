<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reddit Ad Copy Generator</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
        }
        .header {
            background: white;
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            text-align: center;
        }
        .header h1 {
            font-size: 32px;
            color: #333;
            margin-bottom: 5px;
        }
        .header p {
            color: #666;
        }
        .card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        .card h2 {
            font-size: 20px;
            color: #333;
            margin-bottom: 20px;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: #333;
            font-size: 14px;
        }
        input, textarea {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        textarea {
            resize: vertical;
            min-height: 60px;
        }
        input:focus, textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        button {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 14px;
        }
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        .btn-primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        .btn-secondary {
            background: #f5f5f5;
            color: #333;
        }
        .btn-secondary:hover {
            background: #e0e0e0;
        }
        .logs {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            max-height: 300px;
            overflow-y: auto;
            font-size: 13px;
            font-family: monospace;
            line-height: 1.6;
        }
        .log-entry {
            padding: 8px;
            margin-bottom: 5px;
            background: white;
            border-radius: 4px;
            border-left: 3px solid #667eea;
        }
        .log-success { border-left-color: #2e7d32; color: #2e7d32; }
        .log-error { border-left-color: #d32f2f; color: #d32f2f; }
        .log-info { border-left-color: #667eea; color: #667eea; }

        .stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }
        .stat-box {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
        }
        .stat-label {
            font-size: 12px;
            opacity: 0.9;
            margin-bottom: 8px;
            text-transform: uppercase;
        }
        .stat-value {
            font-size: 28px;
            font-weight: 700;
        }

        .results-section {
            margin-top: 20px;
        }
        .result-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            border-left: 4px solid #667eea;
        }
        .result-item h4 {
            color: #333;
            margin-bottom: 8px;
            font-size: 14px;
        }
        .result-item p {
            color: #666;
            font-size: 13px;
            line-height: 1.6;
        }
        .ad-copy {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #667eea;
            margin-top: 15px;
            max-height: 400px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
            line-height: 1.6;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        .copy-btn {
            padding: 8px 12px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            margin-top: 10px;
        }
        .copy-btn:hover {
            background: #5568d3;
        }
        .hidden { display: none; }
        .loading { text-align: center; padding: 20px; }
        .spinner {
            border: 3px solid #f0f0f0;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .note {
            background: #e3f2fd;
            border-left: 4px solid #1976d2;
            padding: 12px;
            border-radius: 4px;
            margin-top: 15px;
            font-size: 13px;
            color: #1565c0;
        }
        @media (max-width: 768px) {
            .stats {
                grid-template-columns: 1fr;
            }
            .header h1 {
                font-size: 24px;
            }
            .button-group {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üî• Reddit Ad Copy Generator</h1>
            <p>Scrape Reddit ‚Üí Analyze Trends ‚Üí Generate Long-Form Ads</p>
        </div>

        <!-- Input Card -->
        <div class="card">
            <h2>‚öôÔ∏è Settings</h2>
            <div class="form-group">
                <label for="apiKey">Anthropic API Key *</label>
                <input type="password" id="apiKey" placeholder="sk-ant-..." />
                <small style="color: #666; margin-top: 5px; display: block;">Get from <a href="https://console.anthropic.com" target="_blank">console.anthropic.com</a></small>
            </div>

            <div class="form-group">
                <label for="subreddits">Subreddits (comma-separated) *</label>
                <input type="text" id="subreddits" placeholder="Divorce,fitness,selfimprovement" value="Divorce,DeadBedrooms,marriageadvice,fitness,selfimprovement" />
            </div>

            <div class="form-group">
                <label for="query">Search Query *</label>
                <input type="text" id="query" placeholder="divorce marriage fitness" value="divorce marriage fitness transformation" />
            </div>

            <div class="button-group">
                <button class="btn-primary" id="startBtn" onclick="startScrape()">üöÄ Start Scrape</button>
                <button class="btn-secondary" onclick="clearResults()">Clear</button>
            </div>
        </div>

        <!-- Logs Card -->
        <div class="card">
            <h2>üìä Progress</h2>
            <div id="logs" class="logs">
                <div class="log-entry log-info">Ready to scrape. Enter your API key and click Start.</div>
            </div>
        </div>

        <!-- Results Card -->
        <div id="resultsCard" class="card hidden">
            <h2>üìà Results</h2>
            
            <div class="stats" id="stats"></div>

            <div id="trendsSection" class="results-section hidden">
                <h3 style="color: #333; margin-bottom: 15px;">üß† Emotional Patterns</h3>
                <div id="emotionalPatterns"></div>

                <h3 style="color: #333; margin: 20px 0 15px;">üò£ Pain Points</h3>
                <div id="painPoints"></div>

                <h3 style="color: #333; margin: 20px 0 15px;">‚úçÔ∏è Generated Ad Copy</h3>
                <div id="adCopyContainer"></div>

                <div class="button-group" style="margin-top: 20px;">
                    <button class="btn-secondary" onclick="downloadResults()">üì• Download Results</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_KEY_INPUT = document.getElementById('apiKey');
        const SUBREDDITS_INPUT = document.getElementById('subreddits');
        const QUERY_INPUT = document.getElementById('query');
        const LOGS_DIV = document.getElementById('logs');
        const RESULTS_CARD = document.getElementById('resultsCard');

        function addLog(message, type = 'info') {
            const entry = document.createElement('div');
            entry.className = `log-entry log-${type}`;
            entry.textContent = message;
            LOGS_DIV.appendChild(entry);
            LOGS_DIV.scrollTop = LOGS_DIV.scrollHeight;
        }

        async function startScrape() {
            const apiKey = API_KEY_INPUT.value.trim();
            const subreddits = SUBREDDITS_INPUT.value.split(',').map(s => s.trim());
            const query = QUERY_INPUT.value.trim();

            if (!apiKey) {
                addLog('‚ùå Please enter your API key', 'error');
                return;
            }
            if (subreddits.length === 0 || !subreddits[0]) {
                addLog('‚ùå Please enter at least one subreddit', 'error');
                return;
            }
            if (!query) {
                addLog('‚ùå Please enter a search query', 'error');
                return;
            }

            LOGS_DIV.innerHTML = '';
            addLog('üîÑ Starting scrape...', 'info');

            try {
                // Scrape Reddit
                addLog('üìç Scraping Reddit...', 'info');
                const { posts, comments } = await scrapeReddit(subreddits, query);
                addLog(`‚úì Found ${posts.length} posts and ${comments.length} comments`, 'success');

                if (comments.length === 0) {
                    addLog('‚ö†Ô∏è No comments found. Try different subreddits.', 'error');
                    return;
                }

                // Analyze trends
                addLog('üß† Analyzing trends...', 'info');
                const trends = await analyzeTrends(comments, apiKey);
                addLog('‚úì Trends analyzed', 'success');

                // Generate ad copy
                addLog('‚úçÔ∏è Generating ad copy...', 'info');
                const adCopy = await generateAdCopy(trends, query, apiKey);
                addLog('‚úì Ad copy generated', 'success');

                // Display results
                displayResults({
                    postCount: posts.length,
                    commentCount: comments.length,
                    trends,
                    adCopy,
                    query
                });

                addLog('‚úì Done! Results below.', 'success');

            } catch (error) {
                addLog(`‚ùå Error: ${error.message}`, 'error');
                console.error(error);
            }
        }

        async function scrapeReddit(subreddits, query) {
            const allPosts = [];
            const allComments = [];

            for (const sub of subreddits) {
                try {
                    const url = `https://www.reddit.com/r/${sub}/search.json?q=${encodeURIComponent(query)}&restrict_sr=1&sort=relevance&limit=20`;
                    const resp = await fetch(url, { headers: { 'User-Agent': 'ResearchBot/1.0' } });
                    const data = await resp.json();

                    if (data.data?.children) {
                        for (const post of data.data.children) {
                            allPosts.push(post.data);
                            
                            // Get comments
                            try {
                                const commentsUrl = `https://www.reddit.com${post.data.permalink}.json?sort=top&limit=15`;
                                const cResp = await fetch(commentsUrl, { headers: { 'User-Agent': 'ResearchBot/1.0' } });
                                const cData = await cResp.json();
                                
                                if (Array.isArray(cData) && cData[1]?.data?.children) {
                                    for (const c of cData[1].data.children) {
                                        if (c.data?.body && c.data.body.length > 10) {
                                            allComments.push(c.data.body);
                                        }
                                    }
                                }
                            } catch (e) {}
                            
                            await new Promise(r => setTimeout(r, 500));
                        }
                    }
                } catch (e) {
                    console.log(`Error scraping r/${sub}`);
                }
                await new Promise(r => setTimeout(r, 2000));
            }

            return { posts: allPosts, comments: allComments };
        }

        async function analyzeTrends(comments, apiKey) {
            const text = comments.slice(0, 50).join('\n\n');

            const response = await fetch('https://api.anthropic.com/v1/messages', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'x-api-key': apiKey,
                    'anthropic-version': '2023-06-01'
                },
                body: JSON.stringify({
                    model: 'claude-opus-4-6',
                    max_tokens: 2000,
                    messages: [{
                        role: 'user',
                        content: `Analyze these Reddit comments for market research. Identify:
1. Top 5 emotional patterns (with exact quotes)
2. Top 5 pain points (with frequency)
3. Language patterns people use

Comments:
${text}

Format as JSON:
{
  "emotional_patterns": [{"emotion": "...", "example": "..."}],
  "pain_points": [{"point": "...", "frequency": "high/medium"}],
  "language_patterns": [{"pattern": "...", "example": "..."}]
}`
                    }]
                })
            });

            if (!response.ok) throw new Error('Claude API error');
            const data = await response.json();
            const jsonMatch = data.content[0].text.match(/\{[\s\S]*\}/);
            return JSON.parse(jsonMatch[0]);
        }

        async function generateAdCopy(trends, query, apiKey) {
            const trendsText = JSON.stringify(trends, null, 2);

            const response = await fetch('https://api.anthropic.com/v1/messages', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'x-api-key': apiKey,
                    'anthropic-version': '2023-06-01'
                },
                body: JSON.stringify({
                    model: 'claude-opus-4-6',
                    max_tokens: 3000,
                    messages: [{
                        role: 'user',
                        content: `Based on this research, write 2 long-form story ad angles (600-800 words each) for people searching: "${query}"

Use the exact emotional language from the data. Make it feel native and authentic.

Trends:
${trendsText}

Write as:
---AD #1---
[Long story ad here]

---AD #2---
[Different angle]`
                    }]
                })
            });

            if (!response.ok) throw new Error('Claude API error');
            const data = await response.json();
            return data.content[0].text;
        }

        function displayResults(data) {
            RESULTS_CARD.classList.remove('hidden');

            // Stats
            const statsDiv = document.getElementById('stats');
            statsDiv.innerHTML = `
                <div class="stat-box">
                    <div class="stat-label">Posts Analyzed</div>
                    <div class="stat-value">${data.postCount}</div>
                </div>
                <div class="stat-box">
                    <div class="stat-label">Comments Analyzed</div>
                    <div class="stat-value">${data.commentCount}</div>
                </div>
            `;

            // Trends
            const trendsSection = document.getElementById('trendsSection');
            trendsSection.classList.remove('hidden');

            if (data.trends?.emotional_patterns) {
                const ep = document.getElementById('emotionalPatterns');
                ep.innerHTML = data.trends.emotional_patterns.map(e => `
                    <div class="result-item">
                        <h4>üß† ${e.emotion}</h4>
                        <p>${e.example || ''}</p>
                    </div>
                `).join('');
            }

            if (data.trends?.pain_points) {
                const pp = document.getElementById('painPoints');
                pp.innerHTML = data.trends.pain_points.map(p => `
                    <div class="result-item">
                        <h4>üò£ ${p.point}</h4>
                        <p>Frequency: ${p.frequency}</p>
                    </div>
                `).join('');
            }

            // Ad copy
            const adDiv = document.getElementById('adCopyContainer');
            adDiv.innerHTML = `
                <div class="ad-copy">${data.adCopy}</div>
                <button class="copy-btn" onclick="copyToClipboard('${data.adCopy.replace(/'/g, "\\'")}')">üìã Copy All</button>
            `;

            window.lastResults = data;
        }

        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                alert('‚úì Copied to clipboard!');
            });
        }

        function downloadResults() {
            if (!window.lastResults) return;
            const data = window.lastResults;
            const content = `
REDDIT RESEARCH REPORT
${new Date().toLocaleString()}

QUERY: ${data.query}

STATS:
- Posts: ${data.postCount}
- Comments: ${data.commentCount}

EMOTIONAL PATTERNS:
${data.trends.emotional_patterns?.map(e => `- ${e.emotion}: "${e.example}"`).join('\n')}

PAIN POINTS:
${data.trends.pain_points?.map(p => `- ${p.point} (${p.frequency})`).join('\n')}

---

AD COPY:

${data.adCopy}
            `.trim();

            const blob = new Blob([content], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `reddit-research-${new Date().getTime()}.txt`;
            a.click();
        }

        function clearResults() {
            RESULTS_CARD.classList.add('hidden');
            LOGS_DIV.innerHTML = '<div class="log-entry log-info">Ready to scrape again.</div>';
        }
    </script>
</body>
</html>
